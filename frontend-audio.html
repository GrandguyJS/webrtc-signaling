<!DOCTYPE html>
<html>
    <body>
        <video id="remoteVideo" autoplay playsinline></video>

        <script>
            const ws = new WebSocket("ws://192.168.178.24:8765");
            const pc = new RTCPeerConnection({
                iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
            });

            ws.onopen = () => {
                ws.send(JSON.stringify({ id: "B" }));
            };

            function send(msg) {
                msg.from = "B";
                msg.to = "A";
                ws.send(JSON.stringify(msg));
            }

            pc.onicecandidate = e => {
                if (e.candidate) send({ candidate: e.candidate });
            };

            pc.ontrack = e => {
                document.getElementById("remoteVideo").srcObject = e.streams[0];
            };

            let pendingCandidates = [];

            ws.onmessage = async event => {
                const msg = JSON.parse(event.data);

                if (msg.type === "offer") {
                    if (!pc.currentRemoteDescription) {
                        await pc.setRemoteDescription(msg.sdp);

                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        stream.getTracks().forEach(t => pc.addTrack(t, stream));

                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        send({ type: "answer", sdp: pc.localDescription });

                        pendingCandidates.forEach(c => pc.addIceCandidate(c));
                        pendingCandidates = [];
                    }
                }

                if (msg.candidate) {
                    if (!pc.remoteDescription) {
                        return pendingCandidates.push(msg.candidate);
                    }
                    await pc.addIceCandidate(msg.candidate);
                }
            };
        </script>
    </body>
</html>
