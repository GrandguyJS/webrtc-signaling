<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>User B</title>
  <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
</head>
<body>
  <h2>User B</h2>
  <div id="remote-container"></div>
  <br>
  <label><input type="checkbox" id="toggleVideo" checked> Video</label>
  <br>
  <label><input type="checkbox" id="toggleAudio" checked> Audio</label>
  <br>
  <button id="image-capture">Download frame</button>
  <br>
  <button id="video-capture">Download video</button>
  <script>
    let token;
    async function getToken() {
      const saved = localStorage.getItem("lk_token_b");
      if (saved) return saved;

      const pwd = prompt("Enter password:");

      const res = await fetch(`https://live-chat.duckdns.org/token?pwd=${encodeURIComponent(pwd)}&identity=userb`);
      const data = await res.json();
      if (data.error) {
        alert("Wrong password!");
        return;
      }
      localStorage.setItem("lk_token_b", data.token);
      return data.token;
    }
    (async () => {
      const url = "wss://live-chat.duckdns.org";  // same server
      token = await getToken();
      
      const room = new LivekitClient.Room();

      room.on(LivekitClient.RoomEvent.TrackSubscribed, (track) => {
        console.log(track);
        const el = track.attach();
        document.getElementById("remote-container").appendChild(el);
      });

      await room.connect(url, token);

      // publish cam+mic
      await room.localParticipant.setCameraEnabled(true);
      await room.localParticipant.setMicrophoneEnabled(true);

      document.getElementById("toggleVideo").addEventListener("change", async (e) => {
        room.localParticipant.setCameraEnabled(e.target.checked);
      });

      document.getElementById("toggleAudio").addEventListener("change", async (e) => {
        room.localParticipant.setMicrophoneEnabled(e.target.checked);
      });

      document.getElementById("image-capture").onclick = async () => {
        await room.localParticipant.performRpc({
          destinationIdentity: "usera",
          method: "image",
          payload: "{}",
        });
      };

      document.getElementById("video-capture").onclick = async () => {
        await room.localParticipant.performRpc({
          destinationIdentity: "usera",
          method: "video",
          payload: "{}",
        });
      };

      room.registerRpcMethod("upload-done", async (data) => {
        const filename = data?.payload?.name;
        const a = document.createElement("a");

        a.href = "/latest?" + Date.now();
        a.download = filename || "download";

        document.body.appendChild(a);
        a.click();
        a.remove();

        return { ok: true };
      });
    })().catch(async (err) => {
        console.error(err);
        localStorage.removeItem("lk_token_b");
      }
    );
  </script>
</body>
</html>
