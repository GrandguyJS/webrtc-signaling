
<!DOCTYPE html>
<html>
    <body>
    <audio id="remoteAudio" autoplay></audio>
    <video id="localPreview" autoplay muted playsinline></video>
    <button onclick="document.getElementById('remoteAudio').play()">Start Audio</button>
    <script>
        const ws = new WebSocket("ws://192.168.178.24:8765");
        const pc = new RTCPeerConnection({
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        });

        ws.onopen = () => {
            ws.send(JSON.stringify({ id: "A" }));
        };

        function send(msg) {
            msg.from = "A";
            msg.to = "B";
            ws.send(JSON.stringify(msg));
        }

        pc.onicecandidate = e => {
            if (e.candidate) send({ candidate: e.candidate });
        };

        pc.ontrack = e => {
            document.getElementById("remoteAudio").srcObject = e.streams[0];
        };

        (async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            stream.getTracks().forEach(t => pc.addTrack(t, stream));

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            send({ type: "offer", sdp: pc.localDescription });
        })();

        let pendingCandidates = [];

        ws.onmessage = async event => {
            const msg = JSON.parse(event.data);

            if (msg.type === "answer") {
                if (!pc.currentRemoteDescription) {
                    await pc.setRemoteDescription(msg.sdp);
                    pendingCandidates.forEach(c => pc.addIceCandidate(c));
                    pendingCandidates = [];
                }
            }

            if (msg.candidate) {
                if (!pc.remoteDescription) {
                    return pendingCandidates.push(msg.candidate);
                }
                await pc.addIceCandidate(msg.candidate);
            }
        };
    </script>
    </body>
</html>
